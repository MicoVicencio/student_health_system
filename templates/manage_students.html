<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Students - CCC Clinic</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1e3a8a;
            --primary-light: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg); 
            margin: 0; 
            color: var(--text-main);
            line-height: 1.5;
        }

        /* Header & Nav */
        header { 
            background: linear-gradient(135deg, var(--primary) 0%, #1e40af 100%); 
            color: white; 
            padding: 1.25rem 2.5rem; 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            box-shadow: var(--shadow);
        }

        header h1 { font-size: 1.5rem; margin: 0; font-weight: 700; letter-spacing: -0.025em; }

        nav { 
            background: var(--surface); 
            padding: 0; 
            display: flex; 
            justify-content: center;
            gap: 40px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        nav a { 
            text-decoration: none; 
            color: var(--text-muted); 
            font-weight: 600; 
            padding: 1rem 0;
            border-bottom: 3px solid transparent; 
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        nav a:hover { color: var(--primary-light); }
        nav a.active { color: var(--primary); border-bottom-color: var(--primary); }

        .container { padding: 2.5rem; max-width: 1200px; margin: 0 auto; }

        /* Controls */
        .controls { 
            display: flex; 
            gap: 20px; 
            margin-bottom: 30px; 
            align-items: center;
            background: var(--surface);
            padding: 15px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        
        .search-bar { flex: 1; position: relative; }
        .search-bar input { 
            width: 100%; 
            padding: 12px 12px 12px 45px; 
            border-radius: 10px; 
            border: 1px solid var(--border); 
            font-size: 1rem; 
            transition: 0.3s;
            background: #f1f5f9;
            box-sizing: border-box;
        }
        .search-bar input:focus { 
            outline: none; 
            border-color: var(--primary-light); 
            background: white;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
        .search-bar i { position: absolute; left: 16px; top: 15px; color: var(--text-muted); }

        /* Table Design */
        .table-wrapper {
            background: var(--surface);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        table { width: 100%; border-collapse: collapse; }
        th { 
            background: #f8fafc; 
            color: var(--text-muted); 
            font-weight: 600; 
            text-transform: uppercase; 
            font-size: 0.75rem; 
            letter-spacing: 0.05em;
            padding: 1rem;
            border-bottom: 2px solid var(--border);
        }

        td { padding: 1.25rem 1rem; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
        .clickable-row { transition: background 0.2s; cursor: pointer; }
        .clickable-row:hover { background: #f1f5f9; }
        
        .student-id-pill {
            background: #eff6ff;
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 6px;
            font-family: monospace;
            font-weight: 700;
        }

        /* FAB */
        .fab-add { 
            position: fixed; 
            bottom: 40px; 
            right: 40px; 
            width: 64px; 
            height: 64px; 
            background: var(--success); 
            color: white; 
            border-radius: 50%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 24px; 
            box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.4); 
            border: none; 
            cursor: pointer; 
            z-index: 100; 
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        .fab-add:hover { transform: scale(1.1) rotate(90deg); background: #059669; }

        /* Modal Styles */
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; top: 0; 
            width: 100%; height: 100%; 
            background: rgba(15, 23, 42, 0.75); 
            backdrop-filter: blur(4px);
        }
        .modal-content { 
            background: var(--surface); 
            margin: 3% auto; 
            padding: 0; 
            border-radius: 20px; 
            width: 90%; 
            max-width: 850px; 
            max-height: 85vh; 
            overflow: hidden; 
            position: relative; 
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-header {
            padding: 1.5rem 2rem;
            background: #f8fafc;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body { padding: 2rem; overflow-y: auto; flex: 1; }

        .tab-container { 
            display: flex; 
            background: #f1f5f9; 
            padding: 6px; 
            border-radius: 12px; 
            margin-bottom: 25px; 
        }
        .tab-btn { 
            flex: 1; padding: 12px; border: none; background: transparent; 
            cursor: pointer; font-weight: 600; color: var(--text-muted); 
            border-radius: 8px; transition: 0.2s;
        }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: var(--shadow); }

        .section-title { 
            font-size: 0.9rem;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 30px 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }
        .section-title::after { content: ""; flex: 1; height: 1px; background: var(--border); }

        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
        .info-item { 
            padding: 12px 16px; 
            background: #f8fafc; 
            border: 1px solid var(--border); 
            border-radius: 10px; 
        }
        .info-item label { display: block; color: var(--text-muted); font-size: 0.65rem; font-weight: 800; text-transform: uppercase; margin-bottom: 4px; }
        .info-item span { font-size: 1rem; color: var(--text-main); font-weight: 500; }

        /* Forms */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-row { grid-column: span 2; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.85rem; color: var(--text-main); }
        .form-group input, .form-group textarea { 
            width: 100%; padding: 12px; border: 1px solid var(--border); 
            border-radius: 8px; box-sizing: border-box; font-size: 0.95rem;
            transition: 0.2s;
        }
        .form-group input:focus { border-color: var(--primary-light); outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

        .modal-footer { 
            padding: 1.5rem 2rem; 
            background: #f8fafc; 
            border-top: 1px solid var(--border); 
            display: flex; 
            gap: 12px; 
            justify-content: flex-end; 
        }
        
        .btn { 
            padding: 10px 20px; border-radius: 8px; border: none; 
            font-weight: 600; cursor: pointer; transition: 0.2s; 
            display: flex; align-items: center; gap: 8px; font-size: 0.9rem;
        }
        .btn-edit { background: var(--primary); color: white; }
        .btn-delete { background: white; color: var(--danger); border: 1px solid var(--danger); }
        .btn-delete:hover { background: var(--danger); color: white; }
        .btn-save { background: var(--success); color: white; }
        .btn-save:hover { background: #059669; }

        /* Custom Checkbox */
        input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary); }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:12px;">
        <i class="fas fa-clinic-medical fa-lg"></i>
        <h1>UPH SL Clinic Management</h1>
    </div>
    <span><i class="fas fa-user-circle"></i> <strong>{{ nurse['full_name'] }}</strong></span>
</header>

<nav>
    <a href="{{ url_for('nurse_dashboard') }}">Home</a>
    <a href="{{ url_for('manage_students') }}" class="active">Manage Students</a>
    <a href="{{ url_for('visit_history') }}">Visit History</a>
</nav>

<div class="container">
    <div class="controls">
        <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" id="mainSearch" placeholder="Search by Name, ID, Section, or RFID..." oninput="filterData()">
        </div>
        <button id="multiDeleteBtn" class="btn btn-delete" style="display:none;" onclick="deleteSelected()">Delete Selected</button>
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th style="width: 40px; text-align: center;"><input type="checkbox" id="selectAll" onclick="toggleAll(this)"></th>
                    <th>Student Number</th>
                    <th>Full Name</th>
                    <th>Section</th>
                </tr>
            </thead>
            <tbody id="studentBody">
                {% for student in students %}
                <tr class="clickable-row" onclick="viewProfile({{ student['id'] }})" data-search="{{ student['full_name'] }} {{ student['student_number'] }} {{ student['section'] }} {{ student['rfid_uid'] }}">
                    <td style="text-align: center;" onclick="event.stopPropagation()"><input type="checkbox" class="student-checkbox" value="{{ student['id'] }}" onclick="updateDeleteBtn()"></td>
                    <td><span class="student-id-pill">{{ student['student_number'] }}</span></td>
                    <td><strong>{{ student['full_name'] }}</strong></td>
                    <td><span style="color: var(--text-muted)">{{ student['section'] }}</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<button class="fab-add" title="Add New Student" onclick="openAddModal()"><i class="fas fa-plus"></i></button>

<div id="mainModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle" style="margin:0; font-size:1.25rem;">Student Profile</h2>
            <span onclick="closeModal()" style="cursor:pointer; font-size: 24px; color: var(--text-muted);">&times;</span>
        </div>
        
        <div class="modal-body">
            <div id="tabContainer" class="tab-container" style="display:none;">
                <button class="tab-btn active" id="tabManualBtn" onclick="switchTab('manual')">Manual Form</button>
                <button class="tab-btn" id="tabBulkBtn" onclick="switchTab('bulk')">Bulk Import</button>
            </div>

            <div id="viewSection">
                <div class="section-title"><i class="fas fa-user"></i> Personal Details</div>
                <div id="profile_personal" class="info-grid"></div>

                <div class="section-title"><i class="fas fa-heartbeat"></i> Health Profile</div>
                <div id="profile_medical" class="info-grid"></div>

                <div class="section-title"><i class="fas fa-phone-alt"></i> Emergency Contact</div>
                <div id="profile_parent" class="info-grid"></div>

                <div class="modal-footer" style="padding: 1.5rem 0 0 0; background: transparent;">
                    <button class="btn btn-delete" onclick="deleteCurrentStudent()"><i class="fas fa-trash-alt"></i> Delete</button>
                    <button class="btn btn-edit" onclick="enableEditMode()"><i class="fas fa-user-edit"></i> Edit Profile</button>
                </div>
            </div>

            <div id="formSection" style="display:none;">
                <form id="studentForm" action="/save_student" method="POST">
                    <input type="hidden" name="id" id="f_id">
                    <div class="form-grid">
                        <div class="form-group"><label>RFID UID</label><input type="text" name="rfid_uid" id="f_rfid" placeholder="Scan RFID card..."></div>
                        <div class="form-group"><label>Student Number</label><input type="text" name="student_number" id="f_num" required></div>
                        <div class="form-group full-row"><label>Full Name</label><input type="text" name="full_name" id="f_name" required></div>
                        <div class="form-group full-row"><label>Address</label><input type="text" name="address" id="f_address"></div>
                        <div class="form-group"><label>Age</label><input type="number" name="age" id="f_age"></div>
                        <div class="form-group"><label>Grade</label><input type="text" name="grade" id="f_grade" required></div>
                        <div class="form-group"><label>Section</label><input type="text" name="section" id="f_section" required></div>
                        <div class="form-group full-row"><label>Allergies</label><textarea name="allergies" id="f_allergies" rows="1"></textarea></div>
                        <div class="form-group full-row"><label>Medical Condition</label><textarea name="medical_condition" id="f_conditions" rows="1"></textarea></div>
                        <div class="form-group"><label>Parent Name</label><input type="text" name="parent_name" id="f_pname"></div>
                        <div class="form-group"><label>Parent Contact #</label><input type="text" name="parent_contact_number" id="f_pcontact"></div>
                        <div class="form-group full-row"><label>Parent Email</label><input type="email" name="parent_email" id="f_pemail"></div>
                    </div>
                    <div class="modal-footer" style="padding: 1.5rem 0 0 0; background: transparent;">
                        <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-save">Save Student</button>
                    </div>
                </form>
            </div>

            <div id="bulkSection" style="display:none;">
                <div style="background: #eff6ff; padding: 15px; border-radius: 10px; border: 1px solid #dbeafe; margin-bottom: 20px;">
                    <p style="margin:0; font-size: 0.9rem; color: var(--primary);">Upload <strong>.xlsx</strong> or <strong>.csv</strong>. Ensure headers match the sample below.</p>
                </div>
                <div class="sample-box">
                    <div class="sample-table-wrapper">
                        <table class="sample-table" style="font-size: 11px;">
                            <thead><tr><th>rfid_uid</th><th>student_number</th><th>full_name</th><th>grade</th><th>section</th><th>parent_email</th></tr></thead>
                        </table>
                    </div>
                </div>
                <input type="file" id="bulkFile" accept=".csv, .xlsx, .xls" onchange="handleFileSelect(event)" style="margin-top:20px;">
                
                <div id="importConfirmation">
                    <i class="fas fa-check-circle"></i> <span id="confirmMessage"></span>
                    <br><br>
                    <button class="btn btn-save" style="width:100%; justify-content:center;" id="confirmImportBtn" onclick="processBulkImport()">Confirm & Import Now</button>
                </div>

                <div id="importProgress" class="progress-container" style="display:none; margin-top:20px;">
                    <div class="progress-text">
                        <span id="progressStatus">Importing...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div id="progressBarFill" class="progress-bar-fill"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
    /* FUNCTIONS RETAINED AS PER ORIGINAL LOGIC */
    let activeStudentId = null;
    let pendingBulkData = [];

    function filterData() {
        const q = document.getElementById('mainSearch').value.toLowerCase();
        document.querySelectorAll('#studentBody tr').forEach(r => {
            r.style.display = r.getAttribute('data-search').toLowerCase().includes(q) ? "" : "none";
        });
    }

    function viewProfile(id) {
        activeStudentId = id;
        fetch(`/get_student_info/${id}`).then(res => res.json()).then(data => {
            document.getElementById('profile_personal').innerHTML = `
                <div class="info-item"><label>Student ID</label><span class="student-id-pill">${data.student_number}</span></div>
                <div class="info-item"><label>Full Name</label><span>${data.full_name}</span></div>
                <div class="info-item"><label>RFID UID</label><span>${data.rfid_uid || 'Not Set'}</span></div>
                <div class="info-item"><label>Grade / Section</label><span>${data.grade} - ${data.section}</span></div>
                <div class="info-item"><label>Age</label><span>${data.age || 'N/A'}</span></div>
                <div class="info-item" style="grid-column: span 2;"><label>Address</label><span>${data.address || 'N/A'}</span></div>
            `;
            document.getElementById('profile_medical').innerHTML = `
                <div class="info-item" style="grid-column: span 2;"><label>Allergies</label><span style="color:var(--danger); font-weight:bold;">${data.allergies || 'No allergies recorded'}</span></div>
                <div class="info-item" style="grid-column: span 2;"><label>Known Conditions</label><span>${data.medical_condition || 'None'}</span></div>
            `;
            document.getElementById('profile_parent').innerHTML = `
                <div class="info-item"><label>Parent/Guardian</label><span>${data.parent_name || 'N/A'}</span></div>
                <div class="info-item"><label>Contact No.</label><span>${data.parent_contact_number || 'N/A'}</span></div>
                <div class="info-item" style="grid-column: span 2;"><label>Email Address</label><span>${data.parent_email || 'N/A'}</span></div>
            `;
            
            document.getElementById('f_id').value = data.id;
            document.getElementById('f_name').value = data.full_name;
            document.getElementById('f_num').value = data.student_number;
            document.getElementById('f_rfid').value = data.rfid_uid || "";
            document.getElementById('f_age').value = data.age || "";
            document.getElementById('f_grade').value = data.grade;
            document.getElementById('f_section').value = data.section;
            document.getElementById('f_address').value = data.address || "";
            document.getElementById('f_allergies').value = data.allergies || "";
            document.getElementById('f_conditions').value = data.medical_condition || "";
            document.getElementById('f_pname').value = data.parent_name || "";
            document.getElementById('f_pcontact').value = data.parent_contact_number || "";
            document.getElementById('f_pemail').value = data.parent_email || "";

            showSection('view');
            document.getElementById('modalTitle').innerText = "Student Profile";
            document.getElementById('tabContainer').style.display = "none";
            document.getElementById('mainModal').style.display = "block";
        });
    }

    function openAddModal() {
        document.getElementById('studentForm').reset();
        document.getElementById('f_id').value = "";
        document.getElementById('modalTitle').innerText = "Register New Student";
        document.getElementById('tabContainer').style.display = "flex";
        document.getElementById('importProgress').style.display = "none";
        document.getElementById('importConfirmation').style.display = "none";
        switchTab('manual');
        document.getElementById('mainModal').style.display = "block";
    }

    function showSection(type) {
        document.getElementById('viewSection').style.display = type === 'view' ? 'block' : 'none';
        document.getElementById('formSection').style.display = type === 'form' ? 'block' : 'none';
        document.getElementById('bulkSection').style.display = type === 'bulk' ? 'block' : 'none';
    }

    function switchTab(type) {
        showSection(type === 'manual' ? 'form' : 'bulk');
        document.getElementById('tabManualBtn').classList.toggle('active', type === 'manual');
        document.getElementById('tabBulkBtn').classList.toggle('active', type === 'bulk');
    }

    function enableEditMode() {
        showSection('form');
        document.getElementById('modalTitle').innerText = "Edit Student Information";
    }

    function closeModal() { document.getElementById('mainModal').style.display = 'none'; }

    function handleFileSelect(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(evt) {
            const data = new Uint8Array(evt.target.result);
            const wb = XLSX.read(data, {type: 'array'});
            pendingBulkData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            document.getElementById('confirmMessage').innerText = `Valid Data: ${pendingBulkData.length} records found.`;
            document.getElementById('importConfirmation').style.display = 'block';
            document.getElementById('importProgress').style.display = "none";
        };
        reader.readAsArrayBuffer(file);
    }

    async function processBulkImport() {
        const confirmDiv = document.getElementById('importConfirmation');
        const progressDiv = document.getElementById('importProgress');
        const barFill = document.getElementById('progressBarFill');
        const percentText = document.getElementById('progressPercent');

        confirmDiv.style.display = 'none';
        progressDiv.style.display = 'block';
        
        let progress = 0;
        const interval = setInterval(() => {
            if (progress < 90) {
                progress += Math.random() * 8;
                barFill.style.width = progress + "%";
                percentText.innerText = Math.floor(progress) + "%";
            }
        }, 300);

        try {
            const response = await fetch('/bulk_import_students', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(pendingBulkData)
            });
            const result = await response.json();
            clearInterval(interval);
            if (result.success) {
                barFill.style.width = "100%";
                percentText.innerText = "100%";
                setTimeout(() => { alert("Import Successful!"); location.reload(); }, 500);
            } else {
                alert("Error: " + result.message);
                progressDiv.style.display = 'none';
                confirmDiv.style.display = 'block';
            }
        } catch (error) {
            clearInterval(interval);
            alert("Server connection failed.");
            progressDiv.style.display = 'none';
            confirmDiv.style.display = 'block';
        }
    }

    function deleteCurrentStudent() {
        if(confirm("Are you sure you want to delete this student record? This cannot be undone.")) {
            fetch('/delete_students', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ids: [activeStudentId]})
            }).then(() => location.reload());
        }
    }

    function toggleAll(source) {
        document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = source.checked);
        updateDeleteBtn();
    }

    function updateDeleteBtn() {
        const count = document.querySelectorAll('.student-checkbox:checked').length;
        document.getElementById('multiDeleteBtn').style.display = count > 0 ? "block" : "none";
        document.getElementById('multiDeleteBtn').innerHTML = `<i class="fas fa-trash"></i> Delete (${count})`;
    }

    function deleteSelected() {
        const ids = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.value);
        if(confirm(`Delete ${ids.length} selected students?`)) {
            fetch('/delete_students', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ids: ids})
            }).then(() => location.reload());
        }
    }
</script>
</body>
</html>